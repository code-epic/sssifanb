<form *ngIf="identificacionForm" [formGroup]="identificacionForm" autocomplete="off" (ngSubmit)="guardarAfiliado()">
    
    <!-- WRAPPER: PERSONA -> DATOBASICO (Sección 1) -->
    <div formGroupName="persona">
        <div formGroupName="datobasico">
            <!-- SECCIÓN 1: PERSONAL -->
            <div class="card shadow-none border-0 mb-4 bg-transparent">
                <div class="row">
                    <div class="col-lg-9 pr-lg-5">
                        <h6 class="section-title"><i class="fas fa-user-circle"></i>Información Personal</h6>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Cédula de Identidad</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-id-card"></i></span></div>
                                        <input type="text" class="form-control" placeholder="V-00000000" formControlName="cedula">
                                        <div class="input-group-append"><span class="input-group-text"><i class="fas fa-search cursor-pointer"></i></span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Nombres</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-user"></i></span></div>
                                        <input type="text" class="form-control" placeholder="Nombres" formControlName="nombres">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Apellidos</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-user"></i></span></div>
                                        <input type="text" class="form-control" placeholder="Apellidos" formControlName="apellidos">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Fecha de Nacimiento</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-calendar-alt"></i></span></div>
                                        <input type="date" class="form-control" formControlName="fechanacimiento">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Sexo</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-venus-mars"></i></span></div>
                                        <select class="form-control" formControlName="sexo">
                                            <option value="">Seleccione...</option>
                                            <option value="F">FEMENINO</option>
                                            <option value="M">MASCULINO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Estado Civil</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-heart"></i></span></div>
                                        <select class="form-control" formControlName="estadocivil">
                                            <option value="">Seleccione...</option>
                                            <option value="S">SOLTERO</option>
                                            <option value="C">CASADO</option>
                                            <option value="D">DIVORCIADO</option>
                                            <option value="V">VIUDO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="avatar-container text-center">
                            <img src="assets/img/theme/team-4-800x800.jpg" class="rounded-circle shadow mb-3" style="width: 140px; height: 140px; object-fit: cover;">
                            <button type="button" class="btn btn-sm btn-block btn-outline-success"><i class="fas fa-camera mr-2"></i>Cambiar Foto</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End Persona/Datobasico wrapper -->

    <!-- SECCIÓN 2: DATOS MILITARES (TABS) -->
     <div class="mb-4">
         <!-- Tabs Navigation -->
        <ul class="nav modern-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'militar'" (click)="switchTab('militar')">
                    <i class="fas fa-id-badge"></i> Datos Militares
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'banco'" (click)="switchTab('banco')">
                    <i class="fas fa-university"></i> Bancos
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'direccion'" (click)="switchTab('direccion')">
                    <i class="fas fa-map-marker-alt"></i> Dirección
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'fisico'" (click)="switchTab('fisico')">
                    <i class="fas fa-ruler-combined"></i> Físicos
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="card shadow-sm border-0">
            <div class="card-body">
                
                <!-- MILITAR (Root level fields) -->
                <div *ngIf="currentTab === 'militar'" class="fade-in">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="modern-form-group">
                                <label>Componente</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-shield-alt"></i></span></div>
                                    <select class="form-control" formControlName="componente">
                                        <option value="">Seleccione...</option>
                                        <option value="EJ">EJERCITO BOLIVARIANO</option>
                                        <option value="AR">ARMADA BOLIVARIANA</option>
                                        <option value="AV">AVIACION MILITAR BOLIVARIANA</option>
                                        <option value="GN">GUARDIA NACIONAL BOLIVARIANA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="modern-form-group">
                                <label>Grado / Jerarquía</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-star"></i></span></div>
                                    <select class="form-control" formControlName="grado"><option value="">Seleccione...</option></select>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="row">
                        <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Categoría</label>
                                <div class="input-group">
                                    <select class="form-control" formControlName="categoria">
                                        <option value="EFE">EFECTIVO</option>
                                        <option value="ASI">ASIMILADO</option>
                                        <option value="RES">RESERVA</option>
                                        <option value="TRP">TROPA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Clasificación</label>
                                <div class="input-group">
                                    <select class="form-control" formControlName="clase">
                                        <option value="OFI">OFICIAL DE COMANDO</option>
                                        <option value="OFIT">OFICIAL TECNICO</option>
                                        <option value="TPROF">TROPA PROFESIONAL</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Situación</label>
                                <div class="input-group">
                                    <select class="form-control" formControlName="situacion">
                                        <option value="ACT">ACTIVO</option>
                                        <option value="RCP">RESERVA ACTIVA</option>
                                        <option value="FCP">FALLECIDO</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-6">
                            <div class="modern-form-group">
                                <label>Fecha de Ingreso</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-calendar-check"></i></span></div>
                                    <input type="date" class="form-control" formControlName="fingreso">
                                </div>
                            </div>
                         </div>
                         <div class="col-md-6">
                             <div class="modern-form-group">
                                <label>Fecha Último Ascenso</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-medal"></i></span></div>
                                    <input type="date" class="form-control" formControlName="fascenso">
                                </div>
                            </div>
                         </div>
                    </div>
                </div>

                <!-- BANCOS (Nested: persona.datofinanciero) -->
                <div *ngIf="currentTab === 'banco'" class="fade-in">
                    <div formGroupName="persona">
                        <div formGroupName="datofinanciero">
                             <div class="row">
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label>Institución Financiera</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-university"></i></span></div>
                                            <select class="form-control" formControlName="institucion">
                                                <option value="">Seleccione...</option>
                                                <option value="0102">BANCO DE VENEZUELA</option>
                                                <option value="0134">BANESCO</option>
                                                <option value="0105">MERCANTIL</option>
                                                <option value="0177">BANFANB</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label>Tipo de Cuenta</label>
                                        <div class="input-group">
                                            <select class="form-control" formControlName="tipo">
                                                <option value="CA">CORRIENTE</option>
                                                <option value="AH">AHORRO</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="modern-form-group">
                                        <label>Número de Cuenta</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-money-check-alt"></i></span></div>
                                            <input type="text" class="form-control" placeholder="0000-0000-00-0000000000" maxlength="20" formControlName="cuenta">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DIRECCION y CONTACTO -->
                 <div *ngIf="currentTab === 'direccion'" class="fade-in">
                     <div formGroupName="persona">
                        <!-- DIRECCION -->
                        <div formGroupName="direccion">
                             <div class="row">
                                 <div class="col-md-4"><div class="modern-form-group"><label>Estado</label><div class="input-group"><select class="form-control" formControlName="estado"><option value="">Seleccione...</option></select></div></div></div>
                                 <div class="col-md-4"><div class="modern-form-group"><label>Ciudad</label><div class="input-group"><select class="form-control" formControlName="ciudad"><option value="">Seleccione...</option></select></div></div></div>
                                 <div class="col-md-4"><div class="modern-form-group"><label>Municipio</label><div class="input-group"><select class="form-control" formControlName="municipio"><option value="">Seleccione...</option></select></div></div></div>
                             </div>
                              <div class="row">
                                <div class="col-md-8">
                                     <div class="modern-form-group">
                                        <label>Dirección Exacta</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-map-marked-alt"></i></span></div>
                                            <input type="text" class="form-control" placeholder="Av. Principal, Calle..." formControlName="calleavenida">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                     <div class="modern-form-group">
                                        <label>Casa</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="No." formControlName="casa">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                     <div class="modern-form-group">
                                        <label>Apto</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="No." formControlName="apartamento">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CONTACTO -->
                        <div class="row">
                             <div class="col-md-6" formGroupName="telefono">
                                <div class="modern-form-group">
                                    <label>Teléfono Móvil</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-mobile-alt"></i></span></div>
                                        <input type="text" class="form-control" placeholder="(04xx) 000-0000" formControlName="movil">
                                    </div>
                                </div>
                             </div>
                             <div class="col-md-6" formGroupName="correo">
                                <div class="modern-form-group">
                                    <label>Correo Electrónico</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-envelope"></i></span></div>
                                        <input type="email" class="form-control" placeholder="usuario@dominio.com" formControlName="principal">
                                    </div>
                                </div>
                             </div>
                        </div>
                        <div class="row" formGroupName="redsocial">
                             <div class="col-md-4">
                                 <div class="modern-form-group"><label>Twitter</label><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fab fa-twitter"></i></span></div><input type="text" class="form-control" formControlName="twitter"></div></div>
                             </div>
                             <div class="col-md-4">
                                 <div class="modern-form-group"><label>Facebook</label><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fab fa-facebook-f"></i></span></div><input type="text" class="form-control" formControlName="facebook"></div></div>
                             </div>
                             <div class="col-md-4">
                                 <div class="modern-form-group"><label>Instagram</label><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fab fa-instagram"></i></span></div><input type="text" class="form-control" formControlName="instagram"></div></div>
                             </div>
                        </div>
                    </div>
                 </div>

                 <!-- FISICOS -->
                <div *ngIf="currentTab === 'fisico'" class="fade-in">
                    <div formGroupName="persona">
                        <div class="row" formGroupName="datofisico">
                            <div class="col-md-3"><div class="modern-form-group"><label>Estatura (m)</label><div class="input-group"><input type="text" class="form-control" placeholder="1.75" formControlName="talla"></div></div></div>
                            <div class="col-md-3"><div class="modern-form-group"><label>Peso (kg)</label><div class="input-group"><input type="text" class="form-control" placeholder="75" formControlName="peso"></div></div></div>
                        </div>
                        <div class="row" formGroupName="datofisionomico">
                            <div class="col-md-3">
                                <div class="modern-form-group"><label>Grupo Sanguíneo</label>
                                    <div class="input-group"><select class="form-control" formControlName="gruposanguineo"><option value="">Seleccione...</option><option value="O+">O+</option><option value="O-">O-</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                 <div class="modern-form-group"><label>Color de Piel</label>
                                    <div class="input-group"><select class="form-control" formControlName="colorpiel"><option value="">Seleccione...</option><option value="MORENA">MORENA</option><option value="BLANCA">BLANCA</option><option value="NEGRA">NEGRA</option></select></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                 <div class="modern-form-group"><label>Color de Ojos</label>
                                    <div class="input-group"><select class="form-control" formControlName="colorojos"><option value="">Seleccione...</option><option value="CASTAÑO">CASTAÑO</option><option value="NEGRO">NEGRO</option><option value="AZUL">AZUL</option><option value="VERDE">VERDE</option></select></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                 <div class="modern-form-group"><label>Color de Cabello</label>
                                    <div class="input-group"><select class="form-control" formControlName="colorcabello"><option value="">Seleccione...</option><option value="NEGRO">NEGRO</option><option value="CASTAÑO">CASTAÑO</option><option value="RUBIO">RUBIO</option><option value="ROJO">ROJO</option><option value="CANOSO">CANOSO</option></select></div>
                                </div>
                            </div>
                         </div>
                     </div>
                </div>

            </div>
        </div>
     </div>

     <!-- Main Submit Button -->
     <div class="card shadow-none bg-transparent border-0 mb-4">
         <div class="row">
             <div class="col text-right">
                 <button type="submit" class="btn btn-success shadow-sm">
                     <i class="fas fa-save mr-2"></i>Guardar Cambios
                 </button>
             </div>
         </div>
     </div>
</form>

     <!-- SECCIÓN 3: GRUPO FAMILIAR (SEPARATE BLOCK) -->
    <div class="card shadow-sm border-0">
        <div class="card-header border-0 d-flex justify-content-between align-items-center bg-white">
            <h3 class="mb-0 text-dark font-weight-bold">
                <i class="fas fa-users mr-2 text-verde-titulos"></i>Grupo Familiar
            </h3>
             <button class="btn btn-sm btn-pastel-icon shadow-sm" style="background-color: rgba(89, 140, 137, 0.15); color: #598c89;" type="button" data-toggle="modal" data-target="#modalFamiliar">
                 <i class="fas fa-plus"></i>
             </button>
        </div>
            <div class="table-responsive">
                <table class="table align-items-center table-flush table-striped-custom">
                    <thead class="thead-light">
                        <tr>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="fas fa-user-friends mr-2 text-verde-titulos opacity-75"></i>Parentesco
                            </th>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="far fa-id-card mr-2 text-verde-titulos opacity-75"></i>Cédula
                            </th>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="fas fa-user mr-2 text-verde-titulos opacity-75"></i>Nombres y Apellidos
                            </th>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="far fa-calendar-alt mr-2 text-verde-titulos opacity-75"></i>Fecha Nac.
                            </th>
                            <th class="text-right font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="fas fa-cog mr-2 text-verde-titulos opacity-75"></i>Acción
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let familiar of familiares" [class.row-inactive]="familiar.inactivo"
                            (dblclick)="openFamiliarModal(familiar)">
                            <td>
                                <span class="badge badge-pill text-uppercase shadow-sm border" style="background-color: rgba(89, 140, 137, 0.1); color: #598c89; border-color: rgba(89, 140, 137, 0.2) !important; font-size: 0.7rem; padding: 0.5em 0.9em;">
                                     {{ familiar.parentesco }}
                                </span>
                            </td>
                            <td style="color: #32325d; font-weight: 400;">
                                {{ familiar.cedula }}
                            </td>
                            <td style="color: #32325d; font-weight: 400;">
                                {{ familiar.nombres | uppercase }}
                                <span *ngIf="familiar.esMilitar" class="ml-2" title="Personal Militar" data-toggle="tooltip">
                                     <i class="fas fa-user-shield text-verde-titulos"></i>
                                </span>
                            </td>
                            <td class="text-muted">
                                {{ familiar.fechanacimiento | date:'dd/MM/yyyy' }}
                            </td>
                            <td class="text-right">
                                 <div class="dropdown" ngbDropdown placement="bottom-right" container="body">
                                    <button class="btn btn-sm btn-icon-only text-light" ngbDropdownToggle>
                                      <i class="fas fa-ellipsis-v text-verde-titulos"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow" ngbDropdownMenu>
                                      <a class="dropdown-item" href="javascript:void(0)"><i class="fas fa-eye mr-2 text-verde-titulos"></i>Ver Detalle</a>
                                      <a class="dropdown-item" href="javascript:void(0)" (click)="openFamiliarModal(familiar)"><i class="fas fa-edit mr-2 text-verde-titulos"></i>Editar</a>
                                    </div>
                                  </div>
                            </td>
                        </tr>
                        <tr *ngIf="familiares.length === 0">
                             <td colspan="5" class="text-center py-5">
                                <div class="empty-state">
                                    <div class="icon-shape bg-verde-titulos-soft text-verde-titulos rounded-circle shadow-sm mb-3" style="width: 60px; height: 60px; display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-users fa-2x"></i>
                                    </div>
                                    <p class="text-muted mb-0 font-weight-500">Sin grupo familiar registrado</p>
                                </div>
                             </td>
                        </tr>
                    </tbody>
                </table>
            </div>
    </div>


<!-- MODAL FAMILIAR (Needs formGroup binding, keeping same flat form for modal) -->
<div class="modal fade" id="modalFamiliar" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Registrar Familiar</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body" [formGroup]="familiarForm">
           <div class="row">
               <div class="col-md-4">
                    <div class="modern-form-group">
                        <label>Cédula</label>
                        <div class="input-group">
                             <input type="text" class="form-control" placeholder="Cédula" formControlName="cedula">
                        </div>
                    </div>
               </div>
                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label>Nombres y Apellidos</label>
                        <div class="input-group">
                             <input type="text" class="form-control" placeholder="Nombre completo" formControlName="nombres">
                        </div>
                    </div>
               </div>
                <div class="col-md-4">
                    <div class="modern-form-group">
                        <label>Parentesco</label>
                        <div class="input-group">
                             <select class="form-control" formControlName="parentesco">
                                 <option value="">Seleccione...</option>
                                 <option value="HIJO">HIJO</option>
                                 <option value="HIJA">HIJA</option>
                                 <option value="ESPOSA">ESPOSA</option>
                                 <option value="ESPOSO">ESPOSO</option>
                                 <option value="MADRE">MADRE</option>
                                 <option value="PADRE">PADRE</option>
                             </select>
                        </div>
                    </div>
               </div>
           </div>
           <div class="row">
               <div class="col-md-4">
                    <div class="modern-form-group">
                        <label>Fecha Nacimiento</label>
                        <div class="input-group">
                             <input type="date" class="form-control" formControlName="fecha_nacimiento">
                        </div>
                    </div>
               </div>
           </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" (click)="guardarFamiliar()">Guardar</button>
      </div>
    </div>
  </div>
</div>
