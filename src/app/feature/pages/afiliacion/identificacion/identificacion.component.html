<form *ngIf="identificacionForm" [formGroup]="identificacionForm" autocomplete="off" (ngSubmit)="guardarAfiliado()">
    
    <!-- WRAPPER: PERSONA -> DATOBASICO (Sección 1) -->
    <div formGroupName="persona">
        <div formGroupName="datobasico">
            <!-- SECCIÓN 1: PERSONAL -->
            <div class="card shadow-none border-0 mb-4 bg-transparent">
                <div class="row">
                    <div class="col-lg-9 pr-lg-3">
                        <div class="section-title-wrapper d-flex justify-content-between align-items-center">
                            <h6 class="section-title mb-0"><i class="fas fa-user-circle"></i> Información Personal</h6>
                            <div class="antiguedad-badge shadow-sm" *ngIf="tiempoServicio">
                                <i class="fas fa-history"></i> Antigüedad: <span>{{ tiempoServicio }}</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Cédula de Identidad</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-id-card"></i></span></div>
                                        <input type="text" class="form-control" placeholder="V-00000000" formControlName="cedula">
                                        <div class="input-group-append"><span class="input-group-text"><i class="fas fa-search cursor-pointer"></i></span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Nombres</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-user"></i></span></div>
                                        <input type="text" class="form-control" placeholder="Nombres" formControlName="nombres">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Apellidos</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-user"></i></span></div>
                                        <input type="text" class="form-control" placeholder="Apellidos" formControlName="apellidos">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Fecha de Nacimiento</label>
                                    <app-pastel-datepicker formControlName="fechanacimiento" iconClass="fas fa-calendar-alt"></app-pastel-datepicker>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Sexo</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-venus-mars"></i></span></div>
                                        <select class="form-control" formControlName="sexo">
                                            <option value="">Seleccione...</option>
                                            <option value="F">FEMENINO</option>
                                            <option value="M">MASCULINO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="modern-form-group">
                                    <label>Estado Civil</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-heart"></i></span></div>
                                        <select class="form-control" formControlName="estadocivil">
                                            <option value="">Seleccione...</option>
                                            <option value="S">SOLTERO</option>
                                            <option value="C">CASADO</option>
                                            <option value="D">DIVORCIADO</option>
                                            <option value="V">VIUDO</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- NUEVA FILA: Hijos, Tiempo Reconocido, Profesionalización -->
                        <div class="row">
                            <!-- Cantidad de Hijos -->
                            <div class="col-md-3">
                                <div class="modern-form-group">
                                    <label>Cantidad de Hijos</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-child"></i></span></div>
                                        <input type="number" class="form-control" placeholder="0" [formControl]="$any(identificacionForm.get('numerohijos'))">
                                    </div>
                                </div>
                            </div>
                            <!-- Años, Meses, Días Reconocidos -->
                            <div class="col-md-6">
                                <div class="modern-form-group">
                                    <label>Tiempo Reconocido (A / M / D)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-history"></i></span></div>
                                        <!-- Años -->
                                        <input type="number" class="form-control text-center px-1" placeholder="Años" title="Años" [formControl]="$any(identificacionForm.get('areconocido'))">
                                        <div class="input-group-prepend input-group-append"><span class="input-group-text border-left px-2">A</span></div>
                                        <!-- Meses -->
                                        <input type="number" class="form-control text-center px-1 border-left" placeholder="Mes" title="Meses" [formControl]="$any(identificacionForm.get('mreconocido'))">
                                        <div class="input-group-prepend input-group-append"><span class="input-group-text border-left px-2">M</span></div>
                                        <!-- Días -->
                                        <input type="number" class="form-control text-center px-1 border-left" placeholder="Día" title="Días" [formControl]="$any(identificacionForm.get('dreconocido'))">
                                        <div class="input-group-append"><span class="input-group-text border-left px-2">D</span></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Porcentaje de Profesionalización -->
                            <div class="col-md-3">
                                <div class="modern-form-group">
                                    <label>Profesionalización</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-graduation-cap"></i></span></div>
                                        <input type="number" class="form-control" placeholder="0.00" [formControl]="$any(identificacionForm.get('pprof'))">
                                        <div class="input-group-append"><span class="input-group-text">%</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="col-lg-3 d-flex flex-column align-items-center justify-content-start">
                        <!-- Contenedor Foto Pasaporte con tamaño ajustado -->
                        <div class="avatar-container position-relative shadow-sm mt-2" 
                             style="border-radius: 8px; width: 100%; max-width: 215px; aspect-ratio: 3/4; background-color: #f8f9fe; margin: 0 auto; box-sizing: border-box;">

                            <!-- Foto Transicionable (object-fit: contain) -->
                            <img [src]="getFotoUrl()" class="w-100 h-100" id="fotoPrincipal"
                                 style="object-fit: contain; position: absolute; top: 0; left: 0; z-index: 1; border-radius: 8px; transition: transform 0.3s;">
                            
                            <!-- Overlay Clickeable PREMIUM para Modal de Doble Clic -->
                            <div class="position-absolute w-100 h-100 d-flex justify-content-center align-items-center" 
                                 style="top: 0; left: 0; z-index: 3; cursor: pointer; transition: background 0.3s ease; border-radius: 8px;" 
                                 onmouseover="this.style.background='rgba(255,255,255,0.15)'; document.getElementById('fotoPrincipal').style.transform='scale(1.04)'; this.querySelector('.zoom-hint').style.opacity='1'" 
                                 onmouseout="this.style.background='transparent'; document.getElementById('fotoPrincipal').style.transform='scale(1)'; this.querySelector('.zoom-hint').style.opacity='0'"
                                 (dblclick)="triggerModal.click()"
                                 title="Doble clic para expandir al visualizador">
                                 
                                 <div class="zoom-hint d-flex align-items-center justify-content-center" style="opacity: 0; transition: opacity 0.3s ease;">
                                     <i class="fas fa-search-plus text-white shadow-sm" style="font-size: 2.5rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));"></i>
                                 </div>
                            </div>
                            
                            <!-- Botón oculto real en DOM para garantizar disparo en Angular -->
                            <button #triggerModal id="btnZoomModal" style="opacity: 0; position: absolute; z-index: -1;" data-toggle="modal" data-target="#modalZoomFoto"></button>
                            
                            <!-- Botón inferior circular y minimalista para evitar tapar -->
                            <div class="position-absolute" style="top: 8px; right: 8px; z-index: 4;">
                                <button type="button" class="btn btn-sm text-white shadow-sm d-flex align-items-center justify-content-center" 
                                        style="background: rgba(89, 140, 137, 0.9); border: none; border-radius: 50%; width: 32px; height: 32px; padding: 0;" title="Actualizar Foto">
                                    <i class="fas fa-camera"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Grado centrado debajito del marco, fuera de la zona de recorte de la foto -->
                        <div class="w-100 d-flex justify-content-center mt-3" style="z-index: 3;">
                                <img *ngIf="getGradoBadgePath()" [src]="getGradoBadgePath()" alt="Grado" 
                                     style="height: 55px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.25));" 
                                     (error)="badgeImg.style.display='none'" #badgeImg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End Persona/Datobasico wrapper -->

    <!-- SECCIÓN 2: DATOS MILITARES (TABS) -->
     <div class="mb-4">
         <!-- Tabs Navigation -->
        <ul class="nav modern-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'militar'" (click)="switchTab('militar')">
                    <i class="fas fa-id-badge"></i> Datos Militares
                </a>
            </li>
             <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'sueldo'" (click)="switchTab('sueldo')">
                    <i class="fas fa-money-bill-wave"></i> Datos Sueldo
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'antiguedad'" (click)="switchTab('antiguedad')">
                    <i class="fas fa-piggy-bank"></i> Asignaciones
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'banco'" (click)="switchTab('banco')">
                    <i class="fas fa-university"></i> Bancos
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'direccion'" (click)="switchTab('direccion')">
                    <i class="fas fa-map-marker-alt"></i> Dirección
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" [class.active]="currentTab === 'fisico'" (click)="switchTab('fisico')">
                    <i class="fas fa-ruler-combined"></i> Físicos
                </a>
            </li>
           
        </ul>

        <!-- Tab Content -->
        <div class="card shadow-sm border-0">
            <div class="card-body">
                
                <!-- MILITAR (Root level fields) -->
                <div *ngIf="currentTab === 'militar'" class="fade-in">
                    <!-- Fila 1: Fecha Ingreso, Componente, Grado -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="modern-form-group">
                                <label>Fecha de Ingreso</label>
                                <app-pastel-datepicker formControlName="fingreso" iconClass="fas fa-calendar-check"></app-pastel-datepicker>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="modern-form-group">
                                <label>Componente</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-shield-alt"></i></span></div>
                                    <select class="form-control" formControlName="componente">
                                        <option value="">Seleccione...</option>
                                        <option value="EJ">EJERCITO BOLIVARIANO</option>
                                        <option value="AR">ARMADA BOLIVARIANA</option>
                                        <option value="AV">AVIACION MILITAR BOLIVARIANA</option>
                                        <option value="GN">GUARDIA NACIONAL BOLIVARIANA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Grado / Jerarquía</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-star"></i></span></div>
                                    <select class="form-control" formControlName="grado"><option value="">Seleccione...</option></select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fila 2: Categoría, Clasificación, Situación -->
                     <div class="row">
                        <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Categoría</label>
                                <div class="input-group">
                                    <select class="form-control" formControlName="categoria">
                                        <option value="EFE">EFECTIVO</option>
                                        <option value="ASI">ASIMILADO</option>
                                        <option value="RES">RESERVA</option>
                                        <option value="TRP">TROPA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Clasificación</label>
                                <div class="input-group">
                                    <select class="form-control" formControlName="clase">
                                        <option value="OFI">OFICIAL DE COMANDO</option>
                                        <option value="OFIT">OFICIAL TECNICO</option>
                                        <option value="TPROF">TROPA PROFESIONAL</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Situación</label>
                                <div class="input-group">
                                    <select class="form-control" formControlName="situacion">
                                        <option value="ACT">ACTIVO</option>
                                        <option value="RCP">RESERVA ACTIVA</option>
                                        <option value="FCP">FALLECIDO</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fila 3: Último Ascenso, Retiro, Nro Resolución, Posición -->
                    <div class="row">
                         <div class="col-md-3">
                             <div class="modern-form-group">
                                <label>Fecha Último Ascenso</label>
                                <app-pastel-datepicker formControlName="fascenso" iconClass="fas fa-medal"></app-pastel-datepicker>
                            </div>
                         </div>
                         <div class="col-md-3">
                             <div class="modern-form-group">
                                <label>Fecha de Retiro</label>
                                <app-pastel-datepicker formControlName="fretiro" iconClass="fas fa-sign-out-alt"></app-pastel-datepicker>
                            </div>
                         </div>
                         <div class="col-md-3">
                            <div class="modern-form-group">
                                <label>Nro. Resolución</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-file-alt"></i></span></div>
                                    <input type="text" class="form-control" placeholder="Ej: 00123" formControlName="nresuelto">
                                </div>
                            </div>
                        </div>
                         <div class="col-md-3">
                            <div class="modern-form-group">
                                <label>Posición en Escalafón</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-sort-numeric-down"></i></span></div>
                                    <input type="number" class="form-control" placeholder="Posición" formControlName="posicion">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- TAB: DATOS DE SUELDO -->
                <div *ngIf="currentTab === 'sueldo'" class="fade-in">
                    
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between align-items-center border-bottom pb-3">
                            <h4 class="text-verde-titulos font-weight-bold mb-0" style="letter-spacing: -0.5px;">
                                Resumen Salarial
                            </h4>
                            <button class="btn-pastel-icon pastel-success shadow-sm" type="button" 
                                    data-toggle="modal" data-target="#modalHistorialSueldo" title="Ver Historial">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </div>

                    <div class="row" style="margin-top: 20px;">
                        <!-- Columna Ingresos Principales (Ledger Card) -->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow-sm border-0 h-100 ledger-card" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-4 px-4" style="border-left: 4px solid #598c89 !important; border-bottom: 1px solid #f4f5f7 !important;">
                                    <div>
                                        <h6 class="text-uppercase font-weight-bold mb-1" style="color: #94a3b8; font-size: 0.75rem; letter-spacing: 1.2px;">Ingreso Principal</h6>
                                        <h4 class="mb-0 font-weight-500" style="color: #64748b; font-size: 1.15rem;">Sueldo Integral</h4>
                                    </div>
                                    <h3 class="font-weight-500 mb-0" style="color: #598c89; font-size: 1.4rem; letter-spacing: 0.1px;">{{ moneda }} 0.00</h3>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush">
                                        <!-- Item -->
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle mr-3" style="background-color: rgba(89, 140, 137, 0.1); width: 36px; height: 36px;">
                                                    <i class="fas fa-arrow-up" style="color: #598c89; font-size: 0.85rem;"></i>
                                                </div>
                                                <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Sueldo Base</span>
                                            </div>
                                            <span class="font-weight-600 tracking-tight" style="color: #475569; font-size: 1.05rem;">{{ moneda }} 0.00</span>
                                        </li>
                                        <!-- Item -->
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle mr-3" style="background-color: rgba(89, 140, 137, 0.1); width: 36px; height: 36px;">
                                                    <i class="fas fa-chart-bar" style="color: #598c89; font-size: 0.85rem;"></i>
                                                </div>
                                                <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Sueldo Mensual</span>
                                            </div>
                                            <span class="font-weight-600 tracking-tight" style="color: #475569; font-size: 1.05rem;">{{ moneda }} 0.00</span>
                                        </li>
                                        <!-- List Divider -->
                                        <li class="list-group-item text-muted font-weight-500 text-uppercase py-2 px-4" style="background-color: #f8f9fa; font-size: 0.75rem; letter-spacing: 0.5px;">
                                            <i class="fas fa-layer-group mr-2 opacity-50"></i>Bonificaciones
                                        </li>
                                        <!-- Item -->
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle mr-3" style="background-color: rgba(64, 101, 98, 0.06); width: 36px; height: 36px;">
                                                    <i class="fas fa-gift" style="color: #598c89; font-size: 0.85rem;"></i>
                                                </div>
                                                <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Bono Fin de Año</span>
                                            </div>
                                            <span class="font-weight-600 tracking-tight" style="color: #475569; font-size: 1.05rem;">{{ moneda }} 0.00</span>
                                        </li>
                                        <!-- Item -->
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle mr-3" style="background-color: rgba(251, 140, 0, 0.1); width: 36px; height: 36px;">
                                                    <i class="fas fa-sun text-warning" style="font-size: 0.85rem;"></i>
                                                </div>
                                                <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Bono Vacacional</span>
                                            </div>
                                            <span class="font-weight-600 tracking-tight" style="color: #475569; font-size: 1.05rem;">{{ moneda }} 0.00</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Primas -->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow-sm border-0 h-100 ledger-card" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header bg-white border-bottom d-flex align-items-center py-4 px-4" style="border-color: #f4f5f7 !important;">
                                    <div class="icon-circle mr-3" style="width: 38px; height: 38px; background-color: rgba(251, 140, 0, 0.08);">
                                        <i class="fas fa-award text-warning" style="font-size: 1rem;"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0 font-weight-500" style="font-size: 1.05rem; color: #64748b;">Primas y Compensaciones</h5>
                                        <small class="font-weight-500 text-uppercase" style="color: #94a3b8; font-size: 0.70rem; letter-spacing: 0.5px;">Ingresos Colaterales</small>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-items-center mb-0 ledger-table">
                                            <tbody>
                                                <tr>
                                                    <td class="font-weight-500 pl-4 border-top-0 py-3" style="font-size: 0.95rem;">Transporte</td>
                                                    <td class="text-right pr-4 font-weight-600 border-top-0 py-3" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</td>
                                                </tr>
                                                <tr>
                                                    <td class="font-weight-500 pl-4 py-3" style="font-size: 0.95rem;">Descendencia</td>
                                                    <td class="text-right pr-4 font-weight-600 py-3" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</td>
                                                </tr>
                                                <tr>
                                                    <td class="font-weight-500 pl-4 py-3" style="font-size: 0.95rem;">Productividad</td>
                                                    <td class="text-right pr-4 font-weight-600 py-3" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</td>
                                                </tr>
                                                <tr>
                                                    <td class="font-weight-500 pl-4 py-3" style="font-size: 0.95rem;">Estabilidad</td>
                                                    <td class="text-right pr-4 font-weight-600 py-3" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</td>
                                                </tr>
                                                <tr>
                                                    <td class="font-weight-500 pl-4 py-3" style="font-size: 0.95rem;">Profesionalización</td>
                                                    <td class="text-right pr-4 font-weight-600 py-3" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</td>
                                                </tr>
                                                <tr class="bg-light">
                                                    <td class="font-weight-500 pl-4 py-3 text-muted" style="font-size: 0.95rem;"><i class="fas fa-clock mr-2 opacity-5 mt-1"></i>Años de Servicio</td>
                                                    <td class="text-right pr-4 font-weight-600 py-3 text-muted" style="font-size: 1.05rem;">0</td>
                                                </tr>
                                                <tr class="bg-light">
                                                    <td class="font-weight-500 pl-4 py-3 text-muted" style="font-size: 0.95rem;"><i class="fas fa-times-circle mr-2 opacity-5 mt-1"></i>No Ascenso</td>
                                                    <td class="text-right pr-4 font-weight-600 py-3 text-muted" style="font-size: 1.05rem;">0</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: ASIGNACION DE ANTIGUEDAD -->
                <div *ngIf="currentTab === 'antiguedad'" class="fade-in">

                    <div class="row mb-4">
                        <div class="col-12 d-flex justify-content-between align-items-center border-bottom pb-3">
                            <h4 class="text-verde-titulos font-weight-bold mb-0" style="letter-spacing: -0.5px;">
                                Estado de Cuenta Fideicomiso
                            </h4>
                             <button class="btn-pastel-icon pastel-success shadow-sm" type="button" 
                                    data-toggle="modal" data-target="#modalHistorialAntiguedad" title="Ver Historial de Movimientos">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Haberes -->
                        <div class="col-lg-7 mb-4">
                            <!-- Hero Banner: Saldo Disponible -->
                            <div class="card shadow-sm border-0 mb-3 hero-banner-soft" style="border-radius: 12px; overflow: hidden; position: relative; border-left: 4px solid #598c89 !important;">
                                <i class="fas fa-chart-line" style="position: absolute; right: -10px; bottom: -20px; font-size: 6rem; opacity: 0.03;"></i>
                                <div class="card-body py-3 px-4 d-flex justify-content-between align-items-center">
                                    <div style="z-index: 1;">
                                        <h6 class="text-uppercase font-weight-500 mb-1" style="color: #94a3b8; font-size: 0.70rem; letter-spacing: 0.8px;">Saldo Disponible Total</h6>
                                        <h3 class="mb-0 font-weight-600" style="color: #598c89; font-size: 1.4rem; letter-spacing: 0.1px;">{{ moneda }} 0.00</h3>
                                    </div>
                                    <div class="icon-circle shadow-sm" style="width: 42px; height: 42px; background-color: rgba(89, 140, 137, 0.1); z-index: 1;">
                                        <i class="fas fa-wallet" style="font-size: 1.1rem; color: #598c89;"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Ledger A. de Antigüedad -->
                            <div class="card shadow-sm border-0 ledger-card" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header bg-white border-bottom py-3 px-4 d-flex align-items-center" style="border-color: #f4f5f7 !important;">
                                    <div class="icon-circle mr-3" style="width: 34px; height: 34px; background-color: rgba(89, 140, 137, 0.1);"><i class="fas fa-coins" style="color: #598c89; font-size: 0.9rem;"></i></div>
                                    <h6 class="mb-0 font-weight-500" style="font-size: 1.05rem; color: #64748b;">Haberes y Depósitos</h6>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Asignación de Antigüedad</span>
                                            <span class="font-weight-600 tracking-tight" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Depositado en Banco</span>
                                            <span class="font-weight-600 tracking-tight" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Capital en Banco</span>
                                            <span class="font-weight-600 tracking-tight" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Fondo de Garantías</span>
                                            <span class="font-weight-600 tracking-tight" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Diferencia A.A.</span>
                                            <span class="font-weight-600 tracking-tight" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Cargas y Egresos -->
                        <div class="col-lg-5 mb-4">
                            <!-- Retenciones Card -->
                            <div class="card shadow-sm border-0 mb-4 ledger-card" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header bg-white border-bottom py-3 px-4 d-flex align-items-center" style="border-color: #f4f5f7 !important;">
                                    <div class="icon-circle mr-3" style="width: 34px; height: 34px; background-color: rgba(244, 67, 54, 0.1);"><i class="fas fa-exclamation-triangle text-danger" style="font-size: 0.9rem;"></i></div>
                                    <h6 class="mb-0 font-weight-500" style="font-size: 1.05rem; color: #64748b;">Cargos y Retenciones</h6>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="text-danger font-weight-500" style="font-size: 0.95rem;"><i class="fas fa-ban mr-2 opacity-75"></i>Embargo</span>
                                            <span class="text-danger font-weight-600 tracking-tight" style="font-size: 1.05rem;">{{ moneda }} 0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="text-warning font-weight-500 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;"><i class="fas fa-hand-holding-usd mr-2 opacity-75"></i>Anticipos Otorgados</span>
                                            <span class="text-warning font-weight-600 tracking-tight" style="font-size: 1.05rem;">{{ moneda }} 0.00</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Intereses Card -->
                            <div class="card shadow-sm border-0 ledger-card" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header bg-white border-bottom py-3 px-4 d-flex align-items-center" style="border-color: #f4f5f7 !important;">
                                    <div class="icon-circle mr-3" style="width: 34px; height: 34px; background-color: rgba(251, 140, 0, 0.1);"><i class="fas fa-chart-pie text-warning" style="font-size: 0.9rem;"></i></div>
                                    <h6 class="mb-0 font-weight-500" style="font-size: 1.05rem; color: #64748b;">Intereses Caídos</h6>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Calculados Anual</span>
                                            <span class="font-weight-600 tracking-tight" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-3 border-light">
                                            <span class="font-weight-500" style="font-size: 0.95rem; color: #64748b;">Cancelados a la Fecha</span>
                                            <span class="font-weight-600 tracking-tight" style="font-size: 1.05rem; color: #475569;">{{ moneda }} 0.00</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center px-4 py-4 border-light">
                                            <span class="text-warning font-weight-500 text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.5px;"><i class="fas fa-balance-scale mr-2 opacity-75"></i>Deuda Restante</span>
                                            <span class="text-warning font-weight-600 tracking-tight" style="font-size: 1.15rem;">{{ moneda }} 0.00</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata Footer Spanning Full Width -->
                        <div class="col-12 mt-2 mb-4">
                            <div class="card shadow-sm border-0 ledger-card" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-body bg-white py-3 px-4 d-flex justify-content-around align-items-center font-weight-500" style="font-size: 0.85rem; color: #94a3b8;">
                                    <span><i class="far fa-calendar-alt mr-2 opacity-50"></i>Últ. Depósito: N/A</span>
                                    <span><i class="fas fa-percentage mr-2 opacity-50"></i>Aportado: 0.00%</span>
                                    <span><i class="fas fa-plus-circle mr-2 opacity-50"></i>Días Adicionales: 0</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- BANCOS (Nested: persona.datofinanciero) -->
                <div *ngIf="currentTab === 'banco'" class="fade-in">
                    <div formGroupName="persona">
                        <div formGroupName="datofinanciero">
                             <div class="row">
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label>Institución Financiera</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-university"></i></span></div>
                                            <select class="form-control" formControlName="institucion">
                                                <option value="">Seleccione...</option>
                                                <option value="0102">BANCO DE VENEZUELA</option>
                                                <option value="0134">BANESCO</option>
                                                <option value="0105">MERCANTIL</option>
                                                <option value="0177">BANFANB</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="modern-form-group">
                                        <label>Tipo de Cuenta</label>
                                        <div class="input-group">
                                            <select class="form-control" formControlName="tipo">
                                                <option value="CA">CORRIENTE</option>
                                                <option value="AH">AHORRO</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="modern-form-group">
                                        <label>Número de Cuenta</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-money-check-alt"></i></span></div>
                                            <input type="text" class="form-control" placeholder="0000-0000-00-0000000000" maxlength="20" formControlName="cuenta">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DIRECCION y CONTACTO -->
                 <div *ngIf="currentTab === 'direccion'" class="fade-in">
                     <div formGroupName="persona">
                        <!-- DIRECCION -->
                        <div formGroupName="direccion">
                             <div class="row">
                                 <div class="col-md-4"><div class="modern-form-group"><label>Estado</label><div class="input-group"><select class="form-control" formControlName="estado"><option value="">Seleccione...</option></select></div></div></div>
                                 <div class="col-md-4"><div class="modern-form-group"><label>Ciudad</label><div class="input-group"><select class="form-control" formControlName="ciudad"><option value="">Seleccione...</option></select></div></div></div>
                                 <div class="col-md-4"><div class="modern-form-group"><label>Municipio</label><div class="input-group"><select class="form-control" formControlName="municipio"><option value="">Seleccione...</option></select></div></div></div>
                             </div>
                              <div class="row">
                                <div class="col-md-8">
                                     <div class="modern-form-group">
                                        <label>Dirección Exacta</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-map-marked-alt"></i></span></div>
                                            <input type="text" class="form-control" placeholder="Av. Principal, Calle..." formControlName="calleavenida">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                     <div class="modern-form-group">
                                        <label>Casa</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="No." formControlName="casa">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                     <div class="modern-form-group">
                                        <label>Apto</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="No." formControlName="apartamento">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CONTACTO -->
                        <div class="row">
                             <div class="col-md-6" formGroupName="telefono">
                                <div class="modern-form-group">
                                    <label>Teléfono Móvil</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-mobile-alt"></i></span></div>
                                        <input type="text" class="form-control" placeholder="(04xx) 000-0000" formControlName="movil">
                                    </div>
                                </div>
                             </div>
                             <div class="col-md-6" formGroupName="correo">
                                <div class="modern-form-group">
                                    <label>Correo Electrónico</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-envelope"></i></span></div>
                                        <input type="email" class="form-control" placeholder="usuario@dominio.com" formControlName="principal">
                                    </div>
                                </div>
                             </div>
                        </div>
                        <div class="row" formGroupName="redsocial">
                             <div class="col-md-4">
                                 <div class="modern-form-group"><label>Twitter</label><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fab fa-twitter"></i></span></div><input type="text" class="form-control" formControlName="twitter"></div></div>
                             </div>
                             <div class="col-md-4">
                                 <div class="modern-form-group"><label>Facebook</label><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fab fa-facebook-f"></i></span></div><input type="text" class="form-control" formControlName="facebook"></div></div>
                             </div>
                             <div class="col-md-4">
                                 <div class="modern-form-group"><label>Instagram</label><div class="input-group"><div class="input-group-prepend"><span class="input-group-text"><i class="fab fa-instagram"></i></span></div><input type="text" class="form-control" formControlName="instagram"></div></div>
                             </div>
                        </div>
                    </div>
                 </div>

                 <!-- FISICOS -->
                <div *ngIf="currentTab === 'fisico'" class="fade-in">
                    <div formGroupName="persona">
                        <div class="row" formGroupName="datofisico">
                            <div class="col-md-3"><div class="modern-form-group"><label>Estatura (m)</label><div class="input-group"><input type="text" class="form-control" placeholder="1.75" formControlName="talla"></div></div></div>
                            <div class="col-md-3"><div class="modern-form-group"><label>Peso (kg)</label><div class="input-group"><input type="text" class="form-control" placeholder="75" formControlName="peso"></div></div></div>
                        </div>
                        <div class="row" formGroupName="datofisionomico">
                            <div class="col-md-3">
                                <div class="modern-form-group"><label>Grupo Sanguíneo</label>
                                    <div class="input-group"><select class="form-control" formControlName="gruposanguineo"><option value="">Seleccione...</option><option value="O+">O+</option><option value="O-">O-</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="AB+">AB+</option><option value="AB-">AB-</option></select></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                 <div class="modern-form-group"><label>Color de Piel</label>
                                    <div class="input-group"><select class="form-control" formControlName="colorpiel"><option value="">Seleccione...</option><option value="MORENA">MORENA</option><option value="BLANCA">BLANCA</option><option value="NEGRA">NEGRA</option></select></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                 <div class="modern-form-group"><label>Color de Ojos</label>
                                    <div class="input-group"><select class="form-control" formControlName="colorojos"><option value="">Seleccione...</option><option value="CASTAÑO">CASTAÑO</option><option value="NEGRO">NEGRO</option><option value="AZUL">AZUL</option><option value="VERDE">VERDE</option></select></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                 <div class="modern-form-group"><label>Color de Cabello</label>
                                    <div class="input-group"><select class="form-control" formControlName="colorcabello"><option value="">Seleccione...</option><option value="NEGRO">NEGRO</option><option value="CASTAÑO">CASTAÑO</option><option value="RUBIO">RUBIO</option><option value="ROJO">ROJO</option><option value="CANOSO">CANOSO</option></select></div>
                                </div>
                             </div>
                         </div>
                     </div>
                </div>



            </div>
        </div>
     </div>

     <!-- Main Submit Button -->
     <div class="card shadow-none bg-transparent border-0 mb-4">
         <div class="row">
             <div class="col text-right">
                 <button type="submit" class="btn btn-ok">
                     Guardar Cambios
                 </button>
             </div>
         </div>
     </div>
</form>

     <!-- SECCIÓN 3: GRUPO FAMILIAR (SEPARATE BLOCK) -->
    <div class="card shadow-sm border-0">
        <div class="card-header border-0 d-flex justify-content-between align-items-center bg-white">
            <h3 class="mb-0 text-dark font-weight-bold">
                <i class="fas fa-users mr-2 text-verde-titulos"></i>Grupo Familiar
            </h3>
             <button class="btn-pastel-icon pastel-success shadow-sm" type="button" data-toggle="modal" data-target="#modalFamiliar" title="Agregar Familiar">
                 <i class="fas fa-plus"></i>
             </button>
        </div>
            <div class="table-responsive">
                <table class="table align-items-center table-flush table-striped-custom">
                    <thead class="thead-light">
                        <tr>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="fas fa-user-friends mr-2 text-verde-titulos opacity-75"></i>Parentesco
                            </th>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="far fa-id-card mr-2 text-verde-titulos opacity-75"></i>Cédula
                            </th>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="fas fa-user mr-2 text-verde-titulos opacity-75"></i>Nombres y Apellidos
                            </th>
                            <th class="font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="far fa-calendar-alt mr-2 text-verde-titulos opacity-75"></i>Fecha Nac.
                            </th>
                            <th class="text-right font-weight-600 text-verde-titulos" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                <i class="fas fa-cog mr-2 text-verde-titulos opacity-75"></i>Acción
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let familiar of familiares" [class.row-inactive]="familiar.inactivo"
                            (dblclick)="openFamiliarModal(familiar)">
                            <td>
                                <span class="badge badge-pill text-uppercase shadow-sm border" style="background-color: rgba(89, 140, 137, 0.1); color: #598c89; border-color: rgba(89, 140, 137, 0.2) !important; font-size: 0.7rem; padding: 0.5em 0.9em;">
                                     {{ familiar.parentesco }}
                                </span>
                            </td>
                            <td style="color: #32325d; font-weight: 400;">
                                {{ familiar.cedula }}
                            </td>
                            <td style="color: #32325d; font-weight: 400;">
                                {{ familiar.nombres | uppercase }}
                                <span *ngIf="familiar.esMilitar" class="ml-2" title="Personal Militar" data-toggle="tooltip">
                                     <i class="fas fa-user-shield text-verde-titulos"></i>
                                </span>
                            </td>
                            <td class="text-muted">
                                {{ familiar.fechanacimiento | date:'dd/MM/yyyy' }}
                            </td>
                            <td class="text-right">
                                 <div class="dropdown" ngbDropdown placement="bottom-right" container="body">
                                    <button class="btn btn-sm btn-icon-only text-light" ngbDropdownToggle>
                                      <i class="fas fa-ellipsis-v text-verde-titulos"></i>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow" ngbDropdownMenu>
                                      <a class="dropdown-item" href="javascript:void(0)"><i class="fas fa-eye mr-2 text-verde-titulos"></i>Ver Detalle</a>
                                      <a class="dropdown-item" href="javascript:void(0)" (click)="openFamiliarModal(familiar)"><i class="fas fa-edit mr-2 text-verde-titulos"></i>Editar</a>
                                    </div>
                                  </div>
                            </td>
                        </tr>
                        <tr *ngIf="familiares.length === 0">
                             <td colspan="5" class="text-center py-5">
                                <div class="empty-state">
                                    <div class="icon-shape bg-verde-titulos-soft text-verde-titulos rounded-circle shadow-sm mb-3" style="width: 60px; height: 60px; display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-users fa-2x"></i>
                                    </div>
                                    <p class="text-muted mb-0 font-weight-500">Sin grupo familiar registrado</p>
                                </div>
                             </td>
                        </tr>
                    </tbody>
                </table>
            </div>
    </div>


<!-- MODAL FAMILIAR (Needs formGroup binding, keeping same flat form for modal) -->
<div class="modal fade" id="modalFamiliar" tabindex="-1" role="dialog" aria-hidden="true" style="background-color: rgba(50, 50, 93, 0.2);">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px; overflow: hidden;">
      <div class="modal-header border-0 px-4 py-4" style="background-color: #f7fafc;">
        <h5 class="modal-title font-weight-bold" style="color: #32325d;"><i class="fas fa-user-plus mr-2 text-success opacity-75"></i>Ficha del Familiar</h5>
        <button class="btn-pastel-icon pastel-danger" type="button" data-dismiss="modal" aria-label="Close" title="Cerrar Ficha">
            <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body p-4 bg-white" [formGroup]="familiarForm">
           <div class="row">
               
               <!-- Columna Foto Institucional (Rectangular) -->
               <div class="col-lg-3 d-flex flex-column align-items-center border-right pr-4">
                    <div class="avatar-container position-relative overflow-hidden shadow-sm mb-4 w-100" style="border-radius: 8px; aspect-ratio: 3/4; max-width: 190px;">
                        <img src="./assets/img/ipsfa/logo.webp " class="w-100 h-100" style="object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1;">
                        <div class="avatar-overlay d-flex align-items-end justify-content-center pb-4">
                            <button type="button" class="btn btn-ok btn-sm rounded-pill px-4" style="backdrop-filter: blur(2px);">
                                <i class="fas fa-camera mr-2"></i>Capturar
                            </button>
                        </div>
                    </div>
                    <div class="w-100 mb-3 modern-form-group">
                        <label class="text-center w-100 d-block">Estatus Vital</label>
                        <select class="form-control text-center font-weight-bold text-success" style="background-color: rgba(45, 206, 137, 0.05);">
                            <option value="S">SOBREVIVIENTE</option>
                            <option value="F">FALLECIDO</option>
                        </select>
                    </div>
               </div>

               <!-- Columna Formulario de Datos -->
               <div class="col-lg-9 pl-4">
                    <h6 class="text-uppercase text-muted font-weight-bold mb-4" style="font-size: 0.8rem; letter-spacing: 1px; border-bottom: 1px solid #eceff1; padding-bottom: 0.5rem;">Información Básica</h6>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Cédula</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="far fa-id-card"></i></span></div>
                                    <input type="text" class="form-control font-weight-bold" placeholder="Cédula" formControlName="cedula">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="modern-form-group">
                                <label>Nombres y Apellidos</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-user-edit"></i></span></div>
                                    <input type="text" class="form-control font-weight-bold text-uppercase" placeholder="Nombre completo" formControlName="nombres">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Parentesco</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-project-diagram"></i></span></div>
                                    <select class="form-control font-weight-bold" formControlName="parentesco">
                                        <option value="">Seleccione...</option>
                                        <option value="HIJO">HIJO</option>
                                        <option value="HIJA">HIJA</option>
                                        <option value="ESPOSA">ESPOSA</option>
                                        <option value="ESPOSO">ESPOSO</option>
                                        <option value="MADRE">MADRE</option>
                                        <option value="PADRE">PADRE</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Fecha Nacimiento</label>
                                <app-pastel-datepicker formControlName="fecha_nacimiento" iconClass="far fa-calendar-alt"></app-pastel-datepicker>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="modern-form-group">
                                <label>Condición</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-wheelchair"></i></span></div>
                                    <select class="form-control font-weight-bold text-danger">
                                        <option value="N">NINGUNA</option>
                                        <option value="E">ESPECIAL / MENTAL</option>
                                        <option value="F">FÍSICA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
               </div><!-- fin columna form -->
               
           </div><!-- fin row -->
      </div>
      <div class="modal-footer bg-light border-top-0 px-4 py-3 d-flex justify-content-between">
        <button type="button" class="btn btn-cancel" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-ok" (click)="guardarFamiliar()">Guardar Expediente</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL ZOOM FOTO PRINCIPAL (ELEGANCIA LIGHTBOX) -->
<div class="modal fade" id="modalZoomFoto" tabindex="-1" role="dialog" aria-hidden="true" style="background-color: rgba(15, 23, 42, 0.92); backdrop-filter: blur(8px);">
  <div class="modal-dialog modal-dialog-centered modal-xl d-flex justify-content-center" role="document">
    <div class="modal-content border-0 bg-transparent text-center" style="max-width: 900px; box-shadow: none;">
        
        <!-- Boton de cierre Premium -->
        <button type="button" class="close text-white position-absolute" data-dismiss="modal" aria-label="Close" 
                style="right: -10px; top: -30px; z-index: 10; font-size: 2.2rem; opacity: 0.7; transition: opacity 0.2s; outline: none; text-shadow: 0 2px 4px rgba(0,0,0,0.5);"
                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
            <i class="fas fa-times-circle"></i>
        </button>
        
        <!-- Carrusel Fotográfico Visualizador -->
        <div id="carouselFotoExpediente" class="carousel slide" data-ride="carousel" data-interval="false">
            <div class="carousel-inner position-relative rounded-lg">
                
                <!-- Slide Activo (Foto Principal Estilo Polaroid) -->
                <div class="carousel-item active d-flex justify-content-center align-items-center" style="min-height: 50vh;">
                    <div class="position-relative d-inline-block">
                        <!-- Marco Fotográfico Blanco Clásico -->
                        <div class="bg-white shadow-lg mx-auto" style="padding: 12px 12px 40px 12px; border-radius: 4px; border: 1px solid #e2e8f0; transform: rotate(-1deg);">
                            <img [src]="getFotoUrl()" class="img-fluid" style="object-fit: contain; max-height: 65vh; max-width: 100%; border: 1px solid #cbd5e1;">
                            
                            <!-- El grado se acopla como una calcomanía institucional debajo -->
                            <div class="position-absolute d-flex justify-content-center w-100" style="bottom: 12px; left: 0;">
                                <img *ngIf="getGradoBadgePath()" [src]="getGradoBadgePath()" alt="Grado Zoom" 
                                    style="height: 60px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.25));" 
                                    (error)="badgeImgZoom.style.display='none'" #badgeImgZoom>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slide Secundario: Documentos PDF/DNI Futuro -->
                <div class="carousel-item d-flex justify-content-center align-items-center" style="min-height: 50vh;">
                   <div class="position-relative d-inline-block">
                       <div class="d-flex align-items-center justify-content-center flex-column shadow-lg" 
                            style="min-height: 65vh; width: 45vh; max-width: 100%; background: linear-gradient(135deg, #1e293b, #0f172a); padding: 15px; border-radius: 6px; border: 1px solid #334155; transform: rotate(1deg);">
                            
                            <div class="d-flex flex-column align-items-center justify-content-center text-muted w-100 h-100" style="border: 2px dashed #475569; border-radius: 8px;">
                                <i class="fas fa-file-image text-white mb-4" style="font-size: 4.5rem; opacity: 0.25;"></i>
                                <span class="text-white font-weight-bold" style="opacity: 0.6; font-size: 1.2rem; letter-spacing: 1px;">DOCUMENTOS ANEXOS</span>
                                <span class="text-white mt-2" style="opacity: 0.4; font-size: 0.9rem;">Área de Escaneos Fotográficos</span>
                            </div>
                       </div>
                   </div>
                </div>

            </div>
            
            <!-- Controles Premium de Vidrio Esmaltado -->
            <a class="carousel-control-prev" href="#carouselFotoExpediente" role="button" data-slide="prev" style="width: 15%; opacity: 1;">
                <div class="d-flex justify-content-center align-items-center shadow-lg" 
                     style="width: 55px; height: 55px; border-radius: 50%; background: rgba(255,255,255,0.1); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.05); transition: background 0.3s;" 
                     onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                    <i class="fas fa-chevron-left text-white" style="font-size: 1.5rem; margin-right: 4px;"></i>
                </div>
                <span class="sr-only">Anterior</span>
            </a>
            <a class="carousel-control-next" href="#carouselFotoExpediente" role="button" data-slide="next" style="width: 15%; opacity: 1;">
                <div class="d-flex justify-content-center align-items-center shadow-lg" 
                     style="width: 55px; height: 55px; border-radius: 50%; background: rgba(255,255,255,0.1); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.05); transition: background 0.3s;" 
                     onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                    <i class="fas fa-chevron-right text-white" style="font-size: 1.5rem; margin-left: 4px;"></i>
                </div>
                <span class="sr-only">Siguiente</span>
            </a>
        </div>
        
    </div>
  </div>
</div>
