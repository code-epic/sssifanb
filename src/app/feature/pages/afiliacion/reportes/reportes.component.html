<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="loading">
  <div class="loading-card">
    <div class="spinner-box">
      <div class="circle-border"></div>
    </div>
    <p>Analizando datos..</p>
  </div>
</div>

<div  [ngClass]="{'blur-content': loading}">

  <!-- Component Summary Row -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3 mb-xl-0" *ngFor="let comp of resumenComponentes">
      <div class="card shadow-sm border-0 card-stats-componente">
        <div class="card-body p-3">
          <div class="d-flex align-items-center mb-3">
            <div class="rounded-circle shadow-sm p-2 bg-white mr-3 img-container">
              <img [src]="comp.image" [alt]="comp.sigla">
            </div>
            <div class="text-truncate">
              <h5 class="card-title text-teal font-weight-bold mb-0" style="font-size: 0.95rem;">{{ comp.sigla }}</h5>
              <div class="text-muted text-xs text-uppercase font-weight-600 text-truncate" [title]="comp.nombre">{{
                comp.nombre }}</div>
            </div>
          </div>

          <div class="row no-gutters align-items-center border-top pt-2"
            style="border-color: rgba(89, 140, 137, 0.1) !important;">
            <div class="col-6 border-right pr-2" style="border-color: rgba(89, 140, 137, 0.1) !important;">
              <small class="text-muted d-block text-xs font-weight-bold">ACTIVOS</small>
              <span class="h4 font-weight-bold text-dark mb-0">{{ comp.activos | number:'1.0-0' }}</span>
            </div>
            <div class="col-6 pl-3">
              <small class="text-muted d-block text-xs font-weight-bold">R. ACTIVA</small>
              <span class="h4 font-weight-bold text-dark mb-0">{{ comp.reserva | number:'1.0-0' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <hr>

  <div class="row">
    <!-- Componentes & Detalles (Full Width) -->
    <div class="col-12 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3 pl-1">
        <h3 class="mb-0 text-teal font-weight-bold" style="font-size: 1.1rem;">
          <i class="fas fa-university mr-2 opacity-75"></i>Distribución por Componente
        </h3>
        <div class="d-flex">
          <button class="btn-pastel-icon pastel-primary mr-2" type="button" (click)="openChart('componente')"
            title="Ver Gráficas y Estadísticas">
            <i class="fas fa-chart-pie"></i>
          </button>
          <button class="btn-pastel-icon pastel-success" type="button" (click)="exportData('componente')"
            title="Descargar Excel">
            <i class="fas fa-file-excel"></i>
          </button>
        </div>
      </div>

      <div class="table-responsive shadow-sm rounded bg-white">
        <table class="table align-items-center table-flush table-hover table-striped">
          <thead class="thead-light">
            <tr>
              <th class="border-0 bg-transparent" style="width: 50px;"></th> <!-- Chevron -->
              <th class="text-teal font-weight-bold border-0 bg-transparent"
                style="font-size: 0.85rem; letter-spacing: 0.5px;">
                <i class="fas fa-university mr-2 opacity-50"></i>COMPONENTES
              </th>
              <th class="text-right text-teal font-weight-bold border-0 bg-transparent" style="font-size: 0.85rem;">
                <i class="fas fa-calculator mr-2 opacity-50"></i>CANTIDAD
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- Component Rows -->
            <ng-container *ngFor="let item of estadisticasComponente">
              <tr (click)="item.expanded = !item.expanded" style="cursor: pointer;">
                <td class="text-center">
                  <i class="fas fa-chevron-right text-teal transition-icon" [class.rotate-90]="item.expanded"></i>
                </td>
                <td class="font-weight-bold text-dark text-uppercase">
                  {{ item._id }}
                </td>
                <td class="text-right font-weight-bolder text-darker" style="font-size: 1.05rem;">
                  {{ item.total_componente | number:'1.0-0':'es' }}
                </td>
              </tr>
              <!-- Expansion Detail -->
              <tr *ngIf="item.expanded">
                <td colspan="3" class="p-0">
                  <div class="p-4 bg-detail-panel">
                    <h6 class="text-muted text-uppercase text-xs font-weight-bold mb-3 pl-1">
                      <i class="fas fa-layer-group mr-2"></i>Segmentación - {{ item._id }}
                    </h6>
                    <div class="row">
                      <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3" *ngFor="let seg of item.segmentacion">
                        <div class="card shadow-sm border-0 mb-0 bg-white h-100 card-segmentacion">
                          <div class="card-body p-2 px-3 d-flex justify-content-between align-items-center">
                            <span class="text-xs font-weight-bold text-muted">{{ seg.situacion || 'N/A' }}</span>
                            <span class="font-weight-bold text-teal small">{{ seg.total | number:'1.0-0':'es' }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>

            <!-- Grand Total Row / Consolidated Situation -->
            <tr (click)="showGlobalSituacion = !showGlobalSituacion"
              style="cursor: pointer; background-color: rgba(94, 114, 228, 0.03);">
              <td class="text-center">
                <i class="fas fa-chevron-right text-teal transition-icon" [class.rotate-90]="showGlobalSituacion"></i>
              </td>
              <td class="font-weight-bold text-teal">
                <span class="badge-dot mr-2"><i class="bg-success"></i></span>
                CONSOLIDADO NACIONAL (SITUACIÓN)
              </td>
              <td class="text-right font-weight-bolder text-teal h5 mb-0">
                {{ totalGeneral | number:'1.0-0':'es' }}
              </td>
            </tr>
            <!-- Global Situation Detail -->
            <tr *ngIf="showGlobalSituacion">
              <td colspan="3" class="p-0">
                <div class="p-4 bg-detail-panel">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-teal text-uppercase text-xs font-weight-bold mb-0 pl-1">
                      <i class="fas fa-globe-americas mr-2"></i>Totalización Global por Situación
                    </h6>
                    <div class="d-flex">
                      <button class="btn-pastel-icon pastel-primary mr-2" type="button"
                        (click)="openChart('situacion'); $event.stopPropagation()"
                        title="Ver Gráfica">
                        <i class="fas fa-chart-pie"></i>
                      </button>
                      <button class="btn-pastel-icon pastel-success" type="button"
                        (click)="exportData('situacion'); $event.stopPropagation()"
                        title="Descargar Reporte">
                        <i class="fas fa-file-excel"></i>
                      </button>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3" *ngFor="let seg of estadisticasSituacion">
                      <div class="card shadow-sm border-0 mb-0 h-100 card-segmentacion-global">
                        <div class="card-body p-3 d-flex justify-content-between align-items-center">
                          <span class="text-sm font-weight-bold text-dark">{{ seg._id || 'N/A' }}</span>
                          <span class="font-weight-bold text-teal">{{ seg.cantidad | number:'1.0-0':'es' }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>

  <hr>

  <!-- Row 2: Grados -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3 pl-1 mt-2">
        <h3 class="mb-0 text-teal font-weight-bold" style="font-size: 1.1rem;">
          <i class="fas fa-layer-group mr-2 opacity-75"></i>Estadísticas por Grado
        </h3>
        <div class="d-flex">
          <!-- <button class="btn-pastel-icon pastel-primary mr-2" type="button" (click)="openChart('grado')"
            title="Ver Gráficas">
            <i class="fas fa-chart-pie"></i>
          </button> -->
          <button class="btn-pastel-icon pastel-success" type="button" (click)="exportData('grado')"
            title="Descargar Excel">
            <i class="fas fa-file-excel"></i>
          </button>
        </div>
      </div>

      <div class="table-responsive shadow-sm rounded bg-white mb-4">
        <table class="table align-items-center table-flush table-hover table-striped">
          <thead class="thead-light">
            <tr>
              <th class="border-0 bg-transparent" style="width: 50px;"></th>
              <th class="text-teal font-weight-bold border-0 bg-transparent"
                style="font-size: 0.85rem; letter-spacing: 0.5px;">
                <i class="fas fa-id-badge mr-2 opacity-50"></i>GRADO / JERARQUÍA
              </th>
              <th class="text-right text-teal font-weight-bold border-0 bg-transparent" style="font-size: 0.85rem;">
                <i class="fas fa-users mr-2 opacity-50"></i>TOTAL AFILIADOS
              </th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let item of estadisticasGrado">
              <tr (click)="item.expanded = !item.expanded" style="cursor: pointer;">
                <td class="text-center">
                  <i class="fas fa-chevron-right text-teal transition-icon" [class.rotate-90]="item.expanded"></i>
                </td>
                <td class="font-weight-bold text-dark text-uppercase text-sm">
                  {{ item._id }}
                </td>
                <td class="text-right font-weight-bolder text-darker">
                  {{ item.total_grado | number:'1.0-0':'es' }}
                </td>
              </tr>
              <!-- Expansion Detail for Grade -->
              <tr *ngIf="item.expanded">
                <td colspan="3" class="p-0">
                  <div class="p-4 bg-detail-panel">
                    <h6 class="text-muted text-uppercase text-xs font-weight-bold mb-3 pl-1">
                      <i class="fas fa-chart-pie mr-2"></i>Distribución de {{ item._id }}
                    </h6>
                    <div class="row">
                      <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3" *ngFor="let seg of item.segmentacion">
                        <div class="card shadow-sm border-0 mb-0 bg-white h-100 card-segmentacion">
                          <div class="card-body p-2 px-3 d-flex justify-content-between align-items-center">
                            <span class="text-xs font-weight-bold text-muted">{{ seg.situacion || 'N/A' }}</span>
                            <span class="font-weight-bold text-teal small">{{ seg.total | number:'1.0-0':'es' }}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Chart Modal -->
<ng-template #graficoModal let-modal>
  <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-center">
    <h5 class="modal-title font-weight-bold text-teal text-uppercase ml-2 mt-2" style="letter-spacing: 0.5px;">
      <i class="fas fa-chart-bar mr-2 opacity-75"></i>Análisis: <span class="text-dark">{{ chartTitle }}</span>
    </h5>

    <div class="d-flex align-items-center">
      <!-- Filter Controls (Only for Componente/Grado) -->
      <div class="btn-group btn-group-sm mr-3 shadow-sm rounded-pill overflow-hidden"
        *ngIf="currentType !== 'situacion'">
        <button type="button" class="btn btn-sm" [class.btn-primary]="chartFilter === 'activos'"
          [class.btn-secondary]="chartFilter !== 'activos'" (click)="updateChartFilter('activos')">Activos</button>
        <button type="button" class="btn btn-sm" [class.btn-primary]="chartFilter === 'reserva'"
          [class.btn-secondary]="chartFilter !== 'reserva'" (click)="updateChartFilter('reserva')">Reserva</button>
        <button type="button" class="btn btn-sm" [class.btn-primary]="chartFilter === 'total'"
          [class.btn-secondary]="chartFilter !== 'total'" (click)="updateChartFilter('total')">Total</button>
      </div>

      <button type="button" class="btn btn-sm btn-icon-only text-muted" aria-label="Close"
        (click)="modal.dismiss('Cross click')">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="modal-body pt-2">
    <div class="card border-0 shadow-none rounded p-3"
      style="background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);">
      <div class="chart-container" style="position: relative; height:50vh; width:100%">
        <canvas id="statsChart"></canvas>
      </div>
    </div>
    <div class="mt-3 text-center">
      <span class="badge badge-pill badge-light text-muted px-3 py-2 border shadow-sm">
        <i class="fas fa-info-circle mr-1"></i> Visualización dinámica · {{ chartFilter === 'activos' ? 'Solo Personal
        Activo' : (chartFilter === 'reserva' ? 'Solo Personal en Reserva' : 'Población Total') }}
      </span>
    </div>
  </div>
</ng-template>