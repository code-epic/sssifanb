<div class="login-wrapper">
  
  <!-- Fondo Animado (Matte & Formal) -->
  <div class="background-animate"></div>

  <div class="login-content">
    
      <!-- Tarjeta Unificada (Glass Card Formal) -->
      <div class="card-login-modern position-relative" style="overflow: visible;">
        
        <!-- Reloj Flotante (Fuera de la tarjeta, arriba derecha) -->
        <div class="clock-floating">
            {{ formattedDate }}
        </div>

        <!-- Logo siempre visible en la parte superior -->
        <div class="logo-container">
           <img src="./assets/img/ipsfa/logo.webp" alt="Logo SSSIFANB">
        </div>

        <!-- Sección de Bienvenida (Se oculta suavemente) -->
        <div class="welcome-container" [class.fade-out]="introFinished">
          <br>
          <br>
          <h3>SSSIFANB</h3>
          <p>Iniciando Sistema de Seguridad Social...</p>
          <div class="mt-3">
               <i class="fa fa-circle-o-notch fa-spin fa-2x text-muted"></i>
          </div>
        </div>

        <!-- Sección de Formulario (Se expande) -->
        <div class="form-container" [class.active]="introFinished">
            
          <ng-container *ngIf="!showTotpSection; else totpBlock">
              
              <h5 class="login-title">INICIO DE SESIÓN</h5>
              
              <form role="form" #form="ngForm" (ngSubmit)="login()">
                
                <div class="form-group mb-3">
                  <div class="input-group custom-input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="material-icons">person</i></span>
                    </div>
                    <input class="form-control" placeholder="USUARIO" type="text" 
                           [(ngModel)]="usuario" [ngModelOptions]="{standalone: true}" required autocomplete="off">
                  </div>
                </div>

                <div class="form-group mb-4">
                  <div class="input-group custom-input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text"><i class="material-icons">vpn_key</i></span>
                    </div>
                    <input class="form-control" placeholder="CONTRASEÑA" [type]="isHidden ? 'password' : 'text'" 
                           [(ngModel)]="clave" [ngModelOptions]="{standalone: true}" required autocomplete="current-password">
                    <div class="input-group-append cursor-pointer" (click)="isHidden = !isHidden">
                        <span class="input-group-text">
                            <i class="material-icons">{{ isHidden ? 'visibility_off' : 'visibility' }}</i>
                        </span>
                    </div>
                  </div>
                </div>

                <div class="text-center">
                  <button type="submit" class="btn btn-pastel btn-block" [disabled]="loading">
                     <ng-container *ngIf="!loading">
                         INGRESAR <i class="material-icons align-middle ml-1" style="font-size: 16px;">arrow_forward</i>
                     </ng-container>
                     <span *ngIf="loading"><i class="fa fa-spinner fa-spin"></i> VERIFICANDO...</span>
                  </button>
                </div>
                
              </form>
          </ng-container>

          <!-- TOTP Block -->
          <ng-template #totpBlock>
              <ng-container *ngTemplateOutlet="totpSection"></ng-container>
          </ng-template>

           <!-- Footer Mejorado -->
           <div class="simple-footer mt-4">
              <h6 class="font-weight-bold mb-0 text-dark-muted" style="font-size: 0.9rem; letter-spacing: 0.5px;">
                  &copy; {{ fecha }} SSSIFANB
              </h6>
              <small class="text-muted" style="font-size: 0.8rem;">Versión {{version}}</small>
          </div>

        </div>

          <!-- Overlay de Carga y Verificación (Glass Elegante) -->
          <div class="loader-overlay" *ngIf="verifying">
              <div class="loader-content">
                  
                  <div class="loader-icon-container">
                      <!-- Fondo Sutil -->
                      <i class="fas fa-shield-alt shield-bg-icon"></i>
                      
                      <!-- Icono Candado (Verificando) -->
                      <i class="fas fa-lock verifying-lock" *ngIf="!verified"></i>
                      
                      <!-- Icono Check (Verificado) -->
                      <i class="fas fa-check-circle success-icon" *ngIf="verified"></i>
                  </div>
                  
                  <h4 class="text-loader mt-3" [class.text-success]="verified">
                      {{ verified ? 'ACCESO AUTORIZADO' : 'VERIFICANDO CREDENCIALES' }}
                  </h4>
                  
                  <ng-container *ngIf="!verified">
                      <p class="text-muted small mt-2">
                          Espere mientras SSSIFANB valida su información...
                      </p>
                      <div class="spinner-loader"></div>
                  </ng-container>

              </div>
          </div>

      </div>
  </div>
</div>

<!-- Template Reutilizable TOTP -->
<ng-template #totpSection>
  <div class="totp-container text-center" (keydown.escape)="goBackToLogin()">
    <i class="material-icons mb-2" style="font-size: 2.5rem; color: #546e7a;">verified_user</i>
    <h5 class="mb-2 font-weight-bold" style="color: #37474f;">Verificación de Identidad</h5>
    <p class="text-muted mb-3" style="font-size: 0.85rem;">
      Ingrese el código dinámico generado por su dispositivo de seguridad.
    </p>
    
    <div class="otp-container" [class.shake]="isOtpInvalid">
      <div class="otp-wrapper">
        <input #otp0 type="tel" class="otp-box" maxlength="1" (input)="onInput($event, otp1)"
          (keydown)="onKeydown($event, null)" (paste)="onPaste($event)">
        <input #otp1 type="tel" class="otp-box" maxlength="1" (input)="onInput($event, otp2)"
          (keydown)="onKeydown($event, otp0)">
        <input #otp2 type="tel" class="otp-box" maxlength="1" (input)="onInput($event, otp3)"
          (keydown)="onKeydown($event, otp1)">

        <span class="otp-divider"></span>

        <input #otp3 type="tel" class="otp-box" maxlength="1" (input)="onInput($event, otp4)"
          (keydown)="onKeydown($event, otp2)">
        <input #otp4 type="tel" class="otp-box" maxlength="1" (input)="onInput($event, otp5)"
          (keydown)="onKeydown($event, otp3)">
        <input #otp5 type="tel" class="otp-box" maxlength="1" (input)="onInput($event, null)"
          (keydown)="onKeydown($event, otp4)">
      </div>

      <small *ngIf="isOtpInvalid" class="text-danger mt-2 d-block font-weight-bold">Código inválido</small>
    </div>

    <div class="mt-3">
      <button class="btn btn-sm btn-outline-secondary" (click)="goBackToLogin()">
        <i class="material-icons align-middle" style="font-size: 14px;">arrow_back</i> CANCELAR
      </button>
    </div>
  </div>
</ng-template>