<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Sistemas Tecnologicos Code Epic">
  <meta name="author" content="Code Epic Technologies">
  <title>Sandra Dashboard</title>
  <title>Sandra Dashboard</title>
  <link href="./assets/img/brand/favicon0.png" rel="icon" type="image/png">

</head>

<body class="mat-typography">
  <app-root></app-root>
</body>
<script>

  (function () {
    // ConfiguraciÃ³n
    const appId = 'sssifanb';
    const originalError = console.error;
    const originalFetch = window.fetch;
    const OriginalXHR = window.XMLHttpRequest;

    window.addEventListener('message', (event) => {
      if (event.data.type === 'NETWORK_CONTEXT') {
        sessionStorage.setItem('net_info', JSON.stringify(event.data.payload));
        console.log('Network context updated from parent.', event.data.payload);
      }
    });

    function sendToParent(type, message, details = null) {
      if (window.parent) {
        window.parent.postMessage({
          type: 'SDC_LOG',
          app_id: appId,
          source: 'external-app',
          payload: {
            app_id: appId,
            source: 'external-app',
            log_type: type, // 'FETCH', 'XHR', 'ERROR', 'INFO'
            message: message,
            details: details // Objeto estructurado
          }
        }, '*');
      }
    }

    console.error = function (...args) {
      originalError.apply(console, args);
      const msg = args.map(a => (a instanceof Error ? a.message + '\n' + a.stack : a)).join(' ');
      sendToParent('ERROR', msg);
    };

    window.fetch = async function (...args) {
      const [resource, config] = args;
      const url = resource.toString();
      const method = (config && config.method) ? config.method : 'GET';
      const requestBody = (config && config.body) ? config.body : null;

      try {
        const response = await originalFetch(...args);

        if (response.status >= 400) {
          let responseBody = '[No Body]';
          try {
            responseBody = await response.clone().text();
            if (responseBody.length > 5000) responseBody = responseBody.substring(0, 5000) + '... (truncated)';
          } catch (e) { }

          const msg = `HTTP Error ${response.status} ${method} ${url}`;

          sendToParent('FETCH', msg, {
            url: response.url || url,
            method: method,
            status: response.status,
            request_headers: (config && config.headers) ? config.headers : {},
            request_payload: requestBody,
            response_body: responseBody,
            source: 'external-app'
          });
        }

        return response;
      } catch (err) {
        sendToParent('ERROR', `Fetch Exception: ${url} - ${err.message}`, {
          url: url,
          error: err.message
        });
        throw err;
      }
    };

    window.XMLHttpRequest = function () {
      const xhr = new OriginalXHR();
      let method = 'GET';
      let url = '';
      let requestBody = null;
      const requestHeaders = {};

      const originalOpen = xhr.open;
      xhr.open = function (m, u, ...args) {
        method = m;
        url = u;
        return originalOpen.apply(xhr, [m, u, ...args]);
      };

      const originalSetRequestHeader = xhr.setRequestHeader;
      xhr.setRequestHeader = function (header, value) {
        requestHeaders[header] = value;
        return originalSetRequestHeader.apply(xhr, [header, value]);
      };

      const originalSend = xhr.send;
      xhr.send = function (body) {
        requestBody = body;
        return originalSend.apply(xhr, [body]);
      };

      xhr.addEventListener('loadend', function () {
        if (xhr.status >= 400) {
          let responseBody = xhr.responseText || '[No Body]';
          if (responseBody.length > 5000) responseBody = responseBody.substring(0, 5000) + '... (truncated)';

          const msg = `XHR Error ${xhr.status} ${method} ${url}`;

          sendToParent('FETCH', msg, {
            url: xhr.responseURL || url,
            method: method,
            status: xhr.status,
            request_headers: requestHeaders,
            request_payload: requestBody,
            response_body: responseBody,
            source: 'external-app'
          });
        }
      });

      xhr.addEventListener('error', function () {
        sendToParent('ERROR', `XHR Network Exception: ${method} ${url}`, { url: url, method: method });
      });

      return xhr;
    };

    Object.assign(window.XMLHttpRequest, OriginalXHR);

    sendToParent('INFO', `Monitor (XHR/Fetch) iniciado para ${appId}`);

  })();



</script>

</html>